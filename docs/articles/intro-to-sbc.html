<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to the SBC package • sbcrs</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the SBC package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397974-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397974-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sbcrs</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/comparison-to-rstan-sbc.html">Comparison to SBC implemented in rstan</a>
    </li>
    <li>
      <a href="../articles/funnel.html">Neal's Funnel</a>
    </li>
    <li>
      <a href="../articles/intro-to-sbc.html">Introduction to the SBC package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jasonmtroos/sbcrs">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction to the SBC package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jasonmtroos/sbcrs/blob/master/vignettes/intro-to-sbc.Rmd"><code>vignettes/intro-to-sbc.Rmd</code></a></small>
      <div class="hidden name"><code>intro-to-sbc.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sbcrs)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rstan)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt; Loading required package: StanHeaders</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; Loading required package: ggplot2</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; rstan (Version 2.19.2, GitRev: 2e1f913d3ca3)</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt; For execution on a local, multicore CPU with excess RAM we recommend calling</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#&gt; options(mc.cores = parallel::detectCores()).</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#&gt; To avoid recompilation of unchanged Stan programs, we recommend calling</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#&gt; rstan_options(auto_write = TRUE)</span></a></code></pre></div>
<div id="stan-model" class="section level2">
<h2 class="hasAnchor">
<a href="#stan-model" class="anchor"></a>Stan model</h2>
<p>We want to validate a Stan model. The Stan model used in this example has matrix, vector, and scalar parameters. The modeled data <code>y</code> have means and standard deviations that vary by <code>group</code> and <code>type</code>.</p>
<pre><code>data {
  int&lt;lower = 0&gt; n_obs;
  int&lt;lower = 0&gt; n_groups;
  int&lt;lower = 0&gt; n_types;
  int&lt;lower = 1&gt; group[n_obs];
  int&lt;lower = 1&gt; type[n_obs];
  vector[n_obs] y;
}
parameters {
  matrix[n_groups, n_types] mu;
  vector&lt;lower = 0&gt;[n_types] sigma;
  real nu;
}
model {
  sigma ~ exponential(1); 
  for (g in 1:n_groups) {
    mu[g,] ~ normal(0, 1);
  }
  for (o in 1:n_obs) {
    int g;
    int t;
    g = group[o];
    t = type[o];
    y[o] ~ normal(mu[g, t], sigma[t]);
  }
  nu ~ normal(0, 1); // just a nuisance scalar parameter
}</code></pre>
<p>Compile the Stan model.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">my_model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rstan/man/stan_model.html">stan_model</a></span>(<span class="dt">file =</span> <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">'stan'</span>, <span class="st">'normal_group_means.stan'</span>, <span class="dt">package =</span> <span class="st">'sbcrs'</span>))</a></code></pre></div>
</div>
<div id="validating-the-model-via-simulation-based-calibration-with-rank-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#validating-the-model-via-simulation-based-calibration-with-rank-statistics" class="anchor"></a>Validating the model via simulation-based calibration with rank statistics</h2>
<p>To validate the model using the SBC package, we need to define four functions. These functions must have signatures matching those specified in <code><a href="https://rdrr.io/r/utils/help.html">help('SBC', package = 'sbcrs')</a></code> (under <code>$new(data, params, modeled_data, sampling)</code>).</p>
<div id="define-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#define-functions" class="anchor"></a>Define functions</h3>
<div id="data" class="section level4">
<h4 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h4>
<p>The first function generates a named list with a new (possibly random) data set. All of the variables defined in the Stan model’s <code>data</code> section must be represented in this list, except:</p>
<ul>
<li><p>Variables given an explicit value in the <code>data</code> section</p></li>
<li><p>Variables modeled probabilistically in the <code>model</code> section (these are generated by the <code>modeled_data</code> function described below).</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">gen_data &lt;-<span class="st"> </span><span class="cf">function</span>(seed) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(seed <span class="op">+</span><span class="st"> </span><span class="fl">1e6</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  n_obs &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  n_groups &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  n_types &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  group &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(n_groups, <span class="dt">size =</span> n_obs, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  type &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(n_types, <span class="dt">size =</span> n_obs, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">n_obs =</span> n_obs, <span class="dt">n_groups =</span> n_groups, <span class="dt">n_types =</span> n_types, <span class="dt">group =</span> group, <span class="dt">type =</span> type)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">}</a></code></pre></div>
<p>The parameter <code>seed</code> in <code>gen_data</code> is used to set the random seed. It is important to set the random seed in all four functions, otherwise the rank statistics will be biased. Moreover, because the same value of <code>seed</code> is passed to all four functions, it is good practice to add an offset when setting the seed.</p>
</div>
<div id="parameters" class="section level4">
<h4 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h4>
<p>Generate random parameters (but not the modeled data) from the prior distributions indicated in the Stan model.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">gen_params &lt;-<span class="st"> </span><span class="cf">function</span>(seed, data) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(seed <span class="op">+</span><span class="st"> </span><span class="fl">2e6</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(data<span class="op">$</span>n_types)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  mu &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(data<span class="op">$</span>n_groups <span class="op">*</span><span class="st"> </span>data<span class="op">$</span>n_types, <span class="dv">0</span>, <span class="dv">1</span>), </a>
<a class="sourceLine" id="cb5-5" data-line-number="5">               <span class="dt">nrow =</span> data<span class="op">$</span>n_groups)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  nu  &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">sigma =</span> sigma, <span class="dt">mu =</span> mu, <span class="dt">nu =</span> nu)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">}</a></code></pre></div>
</div>
<div id="modeled-parameter" class="section level4">
<h4 class="hasAnchor">
<a href="#modeled-parameter" class="anchor"></a>Modeled parameter</h4>
<p>Generate the modeled parameter—the one that is defined in the <code>data</code> section of the Stan model and modeled probabilistically in the <code>model</code> section. This parameter needs to be generated from the same likelihood (conditional on the model parameters) indicated by the Stan model.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">gen_modeled_data &lt;-<span class="st"> </span><span class="cf">function</span>(seed, data, params) {</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(seed <span class="op">+</span><span class="st"> </span><span class="fl">3e6</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  y_mean &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map2.html">map2_dbl</a></span>(data<span class="op">$</span>group, data<span class="op">$</span>type, <span class="op">~</span>params<span class="op">$</span>mu[.x, .y])</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  y_sd &lt;-<span class="st"> </span>params<span class="op">$</span>sigma[data<span class="op">$</span>type]</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(data<span class="op">$</span>n_obs, y_mean, y_sd))</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">}</a></code></pre></div>
</div>
<div id="sampling" class="section level4">
<h4 class="hasAnchor">
<a href="#sampling" class="anchor"></a>Sampling</h4>
<p>Define a function to draw samples from the Stan model. This function ties together the Stan model <code>my_model</code> and the lists returned by the functions defined above. When calling <code><a href="https://rdrr.io/pkg/rstan/man/stanmodel-method-sampling.html">rstan::sampling</a></code>, pass in a list concatenated from the <code>data</code> and <code>modeled_data</code> lists.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">sample_from_model &lt;-<span class="st"> </span><span class="cf">function</span>(seed, data, params, modeled_data, iters) {</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  data_for_stan &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(data, modeled_data)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  rstan<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rstan/man/stanmodel-method-sampling.html">sampling</a></span>(my_model, <span class="dt">data =</span> data_for_stan, <span class="dt">seed =</span> seed,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                  <span class="dt">chains =</span> <span class="dv">1</span>, <span class="dt">iter =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>iters, <span class="dt">warmup =</span> iters, </a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                  <span class="dt">open_progress =</span> <span class="ot">FALSE</span>, <span class="dt">show_messages =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                  <span class="dt">refresh =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">}</a></code></pre></div>
</div>
</div>
<div id="initialize-a-new-calibration-object" class="section level3">
<h3 class="hasAnchor">
<a href="#initialize-a-new-calibration-object" class="anchor"></a>Initialize a new calibration object</h3>
<p>To create a new calibration object, call <code>SBC$new()</code> passing in references to the functions defined above.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">my_sbc &lt;-<span class="st"> </span>SBC<span class="op">$</span><span class="kw">new</span>(<span class="dt">data =</span> gen_data, </a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                  <span class="dt">params =</span> gen_params, </a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                  <span class="dt">modeled_data =</span> gen_modeled_data, </a>
<a class="sourceLine" id="cb8-4" data-line-number="4">                  <span class="dt">sampling =</span> sample_from_model)</a></code></pre></div>
</div>
<div id="calibration" class="section level3">
<h3 class="hasAnchor">
<a href="#calibration" class="anchor"></a>Calibration</h3>
<p>Calibration involves generating data and parameters, and sampling from a Stan model many times. To speed up this process, take advantage of all of your machine’s cores.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">doParallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span>(<span class="dt">cores =</span> parallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())</a></code></pre></div>
<p>To run the calibration routine, call the <code>$calibrate()</code> method on <code>my_sbc</code>. It will update the fields in this object with the output of the calibration routine.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">my_sbc<span class="op">$</span><span class="kw">calibrate</span>(<span class="dt">N =</span> <span class="dv">32</span>, <span class="dt">L =</span> <span class="dv">20</span>, <span class="dt">keep_stan_fit =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>The results of the calibration routine are now stored in the <code>$calibrations</code> field. This is a list of length <code>N = 32</code>. It contains the data and parameters generated for each. If <code>keep_stan_fit = TRUE</code>, then it also stores the <code>stan_fit</code> objects. This can be memory-intensive, but also useful for debugging.</p>
<p>Each calibration in <code>$calibrations</code> also contains a named list called <code>$ranks</code>. Each parameter <code>var</code> has a corresponding named entry called <code>$ranks$var</code>, whose value is the number of samples (out of a maximum <code>L</code>) for which the sampled value of <code>var</code> was less than <code>params$var</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(my_sbc<span class="op">$</span>calibrations, <span class="st">'ranks'</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#&gt; [[1]]$sigma</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">#&gt; [1]  0  9 17</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; [[1]]$mu</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt;      [,1] [,2] [,3]</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; [1,]   16    7    7</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt; [2,]   14   12   10</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt; [3,]   12   14   11</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt; [4,]   13    6   17</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt; [5,]    5    3   18</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; [[1]]$nu</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt; [1] 0</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="co">#&gt; [[2]]$sigma</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#&gt; [1]  0 10 13</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="co">#&gt; [[2]]$mu</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="co">#&gt;      [,1] [,2] [,3]</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="co">#&gt; [1,]    2    1   13</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"><span class="co">#&gt; [2,]    2   19    4</span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="co">#&gt; [3,]   17    3    8</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="co">#&gt; [4,]    1    3    3</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="co">#&gt; [5,]    9    3   16</span></a>
<a class="sourceLine" id="cb11-29" data-line-number="29"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="co">#&gt; [[2]]$nu</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-34" data-line-number="34"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb11-35" data-line-number="35"><span class="co">#&gt; [[3]]$sigma</span></a>
<a class="sourceLine" id="cb11-36" data-line-number="36"><span class="co">#&gt; [1] 2 0 8</span></a>
<a class="sourceLine" id="cb11-37" data-line-number="37"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-38" data-line-number="38"><span class="co">#&gt; [[3]]$mu</span></a>
<a class="sourceLine" id="cb11-39" data-line-number="39"><span class="co">#&gt;      [,1] [,2] [,3]</span></a>
<a class="sourceLine" id="cb11-40" data-line-number="40"><span class="co">#&gt; [1,]   17   15    7</span></a>
<a class="sourceLine" id="cb11-41" data-line-number="41"><span class="co">#&gt; [2,]   16   14   19</span></a>
<a class="sourceLine" id="cb11-42" data-line-number="42"><span class="co">#&gt; [3,]    9    5   14</span></a>
<a class="sourceLine" id="cb11-43" data-line-number="43"><span class="co">#&gt; [4,]    0   16   13</span></a>
<a class="sourceLine" id="cb11-44" data-line-number="44"><span class="co">#&gt; [5,]   12    3   16</span></a>
<a class="sourceLine" id="cb11-45" data-line-number="45"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-46" data-line-number="46"><span class="co">#&gt; [[3]]$nu</span></a>
<a class="sourceLine" id="cb11-47" data-line-number="47"><span class="co">#&gt; [1] 15</span></a></code></pre></div>
<p>If the generating functions defined above match the Stan model, then these ranks should be uniformly distributed. That is, deviations from uniformity indicate the generating functions in R, the stan model, or both are misspecified.</p>
<p>A quick summary of the calibrations compares the rank statistics to typical inner quantiles.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">my_sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>()</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt;    iq expected.outside actual.outside</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt;  0.50             0.50      0.4761905</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt;  0.95             0.05      0.0952381</span></a></code></pre></div>
<p>When the number of parameters, <code>N</code>, or <code>L</code> are small, these estimates are noisy.</p>
<p>To visualize the ranks and compare them against typical inner quantiles, use the <code>plot</code> function.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">my_sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="intro-to-sbc_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>Passing in the name of one or more parameters to the <code>plot</code> or <code>summary</code> functions yields statistics calculated only for those parameters.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">my_sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'nu'</span>, <span class="st">'sigma'</span>))</a></code></pre></div>
<p><img src="intro-to-sbc_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">my_sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="st">'sigma'</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co">#&gt; sigma.1</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co">#&gt;    iq expected.outside actual.outside</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt;  0.50             0.50      0.3571429</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt;  0.95             0.05      0.0000000</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; sigma.2</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt;    iq expected.outside actual.outside</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#&gt;  0.50             0.50      0.1764706</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt;  0.95             0.05      0.0000000</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt; sigma.3</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt;    iq expected.outside actual.outside</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co">#&gt;  0.50             0.50     0.20000000</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co">#&gt;  0.95             0.05     0.06666667</span></a></code></pre></div>
</div>
</div>
<div id="flexibly-testing-families-of-models" class="section level2">
<h2 class="hasAnchor">
<a href="#flexibly-testing-families-of-models" class="anchor"></a>Flexibly testing families of models</h2>
<p>Because our Stan model allows the number of <code>types</code> and <code>groups</code> to vary, we would ideally test the model using different values of <code>n_types</code> and <code>n_groups</code>. Or, to understand how well the model scales with the number of observations, we might want to test different values of <code>n_obs</code>. To accomplish this, we can create a function that returns a data-generating function with different values of these three inputs.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">new_gen_data_function &lt;-<span class="st"> </span><span class="cf">function</span>(.n_obs, .n_groups, .n_types) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="cf">function</span>(seed) {</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">    <span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(seed <span class="op">+</span><span class="st"> </span><span class="fl">1e6</span>)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    n_obs &lt;-<span class="st"> </span>.n_obs</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    n_groups &lt;-<span class="st"> </span>.n_groups</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    n_types &lt;-<span class="st"> </span>.n_types</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    group &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(n_groups, <span class="dt">size =</span> n_obs, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    type &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(n_types, <span class="dt">size =</span> n_obs, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">n_obs =</span> n_obs, <span class="dt">n_groups =</span> n_groups, <span class="dt">n_types =</span> n_types, <span class="dt">group =</span> group, <span class="dt">type =</span> type)</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">}</a></code></pre></div>
<p>We can similarly wrap the creation of a new SBC object in a generating function.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">new_sbc_object &lt;-<span class="st"> </span><span class="cf">function</span>(n_obs, n_groups, n_types) {</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  gen_data &lt;-<span class="st"> </span><span class="kw">new_gen_data_function</span>(n_obs, n_groups, n_types)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  SBC<span class="op">$</span><span class="kw">new</span>(<span class="dt">data =</span> gen_data, </a>
<a class="sourceLine" id="cb17-4" data-line-number="4">          <span class="dt">params =</span> gen_params, </a>
<a class="sourceLine" id="cb17-5" data-line-number="5">          <span class="dt">modeled_data =</span> gen_modeled_data, </a>
<a class="sourceLine" id="cb17-6" data-line-number="6">          <span class="dt">sampling =</span> sample_from_model)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">}</a></code></pre></div>
<p>1 group and 1 type, zero observations</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">sbc &lt;-<span class="st"> </span><span class="kw">new_sbc_object</span>(<span class="dt">n_obs =</span> <span class="dv">0</span>, <span class="dt">n_groups =</span> <span class="dv">1</span>, <span class="dt">n_types =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">sbc<span class="op">$</span><span class="kw">calibrate</span>(<span class="dt">N =</span> <span class="dv">32</span>, <span class="dt">L =</span> <span class="dv">20</span>, <span class="dt">keep_stan_fit =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="intro-to-sbc_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>1 group and 1 type, 100 observations</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">sbc &lt;-<span class="st"> </span><span class="kw">new_sbc_object</span>(<span class="dt">n_obs =</span> <span class="dv">100</span>, <span class="dt">n_groups =</span> <span class="dv">1</span>, <span class="dt">n_types =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">sbc<span class="op">$</span><span class="kw">calibrate</span>(<span class="dt">N =</span> <span class="dv">32</span>, <span class="dt">L =</span> <span class="dv">20</span>, <span class="dt">keep_stan_fit =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="intro-to-sbc_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>2 groups and 8 types, 200 observations</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">sbc &lt;-<span class="st"> </span><span class="kw">new_sbc_object</span>(<span class="dt">n_obs =</span> <span class="dv">200</span>, <span class="dt">n_groups =</span> <span class="dv">2</span>, <span class="dt">n_types =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">sbc<span class="op">$</span><span class="kw">calibrate</span>(<span class="dt">N =</span> <span class="dv">32</span>, <span class="dt">L =</span> <span class="dv">20</span>, <span class="dt">keep_stan_fit =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>()</a></code></pre></div>
<p><img src="intro-to-sbc_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">sbc<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>()</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="co">#&gt;    iq expected.outside actual.outside</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="co">#&gt;  0.50             0.50      0.6190476</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="co">#&gt;  0.95             0.05      0.0952381</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#stan-model">Stan model</a></li>
      <li><a href="#validating-the-model-via-simulation-based-calibration-with-rank-statistics">Validating the model via simulation-based calibration with rank statistics</a></li>
      <li><a href="#flexibly-testing-families-of-models">Flexibly testing families of models</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jason Roos.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
